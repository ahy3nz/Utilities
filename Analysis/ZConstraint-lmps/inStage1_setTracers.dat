variable Nprint equal 100 
variable temperature equal 305.0

units real
atom_style full

pair_style lj/cut/coul/long 14.0 14.0 
bond_style harmonic
angle_style hybrid harmonic cosine/squared
dihedral_style hybrid harmonic charmm
improper_style harmonic
special_bonds lj/coul 0.0 0.0 1.0 
kspace_style pppm 1.0e-4
neighbor 2.4 bin 

#read_data bilayer.lammpsdata
#read_restart restart.100000  
read_data ${datafile}
#read_restart ${restartfile}

include LammpsOostenbrink.txt

group water type 57 58
group tracers molecule ${ID1} ${ID2} ${ID3} ${ID4} ${ID5} ${ID6} ${ID7} 
group allbuttracers subtract all tracers
group bilayer subtract all water

group t1 molecule ${ID1}
group t2 molecule ${ID2}
group t3 molecule ${ID3}
group t4 molecule ${ID4}
group t5 molecule ${ID5}
group t6 molecule ${ID6}
group t7 molecule ${ID7}

reset_timestep 0
variable ke equal ke
variable enthalpy equal enthalpy
variable pe equal pe
variable step equal step
variable temp equal temp
variable press equal press
variable vol equal vol

variable lx equal lx
variable ly equal ly
variable lz equal lz

timestep 1.0

fix 11 all shake 0.0001 10 10000 b 53 a 55
fix 10 water npt temp ${temperature} ${temperature} 100.0 aniso 1.0 1.0 1000.0
fix 12 bilayer nvt temp ${temperature} ${temperature} 100.0 
fix bs1 bilayer spring tether 20.0 NULL NULL 0.0 0.0
fix 3 all print ${Nprint} "${step} ${pe} ${press} ${temp} ${lx} ${ly} ${lz}" file system.log screen no
thermo ${Nprint}

#compute trcom tracer com
#compute tracerfz tracer reduce sum fz
#variable tcomx equal c_trcom[1]
#variable tcomy equal c_trcom[2]
#variable tcomz equal c_trcom[3]
#variable tfz equal c_tracerfz

dump d1 tracers custom 1000 tracerpos.xyz id mass x y z vx vy vz fx fy fz
#dump_modify d1 append yes

dump d2 all custom 1000 trajectory.lammps id type xu yu zu
#dump_modify d2 append yes

# get all tracers to the first window before shifting them to the right
fix st1 t1 spring tether 4.0 NULL NULL ${zt1} 0.0
fix st2 t2 spring tether 4.0 NULL NULL ${zt1} 0.0
fix st3 t3 spring tether 4.0 NULL NULL ${zt1} 0.0
fix st4 t4 spring tether 4.0 NULL NULL ${zt1} 0.0
fix st5 t5 spring tether 4.0 NULL NULL ${zt1} 0.0
fix st6 t6 spring tether 4.0 NULL NULL ${zt1} 0.0
fix st7 t7 spring tether 4.0 NULL NULL ${zt1} 0.0

run 5000

unfix st1
unfix st2
unfix st3
unfix st4
unfix st5
unfix st6
unfix st7

fix st1 t1 spring tether 50.0 NULL NULL ${zt1} 0.0
fix st2 t2 spring tether 50.0 NULL NULL ${zt1} 0.0
fix st3 t3 spring tether 50.0 NULL NULL ${zt1} 0.0
fix st4 t4 spring tether 50.0 NULL NULL ${zt1} 0.0
fix st5 t5 spring tether 50.0 NULL NULL ${zt1} 0.0
fix st6 t6 spring tether 50.0 NULL NULL ${zt1} 0.0
fix st7 t7 spring tether 50.0 NULL NULL ${zt1} 0.0

run 20000

# now get rid of the springs and start fixing things
unfix bs1
unfix st1
unfix st2
unfix st3
unfix st4
unfix st5
unfix st6
unfix st7
unfix 10
unfix 11
unfix 12

fix 11 all shake 0.0001 10 10000 b 53 a 55
fix 10 water npt temp ${temperature} ${temperature} 100.0 aniso 1.0 1.0 1000.0
fix 12 bilayer nvt temp ${temperature} ${temperature} 100.0 
fix mp1 bilayer momentum 1 linear 0 0 1
fix fm1 t1 momentum 1 linear 0 0 1
fix fm2 t2 momentum 1 linear 0 0 1
fix fm3 t3 momentum 1 linear 0 0 1
fix fm4 t4 momentum 1 linear 0 0 1
fix fm5 t5 momentum 1 linear 0 0 1
fix fm6 t6 momentum 1 linear 0 0 1
fix fm7 t7 momentum 1 linear 0 0 1
fix rc1 t1 recenter NULL NULL ${zt1} shift t1
fix rc2 t2 recenter NULL NULL ${zt1} shift t2
fix rc3 t3 recenter NULL NULL ${zt1} shift t3
fix rc4 t4 recenter NULL NULL ${zt1} shift t4
fix rc5 t5 recenter NULL NULL ${zt1} shift t5
fix rc6 t6 recenter NULL NULL ${zt1} shift t6
fix rc7 t7 recenter NULL NULL ${zt1} shift t7

run 5000

unfix rc2
unfix rc3
unfix rc4
unfix rc5
unfix rc6
unfix rc7
unfix fm2
unfix fm3
unfix fm4
unfix fm5
unfix fm6
unfix fm7
fix shiftt2 t2 move linear 0.0 0.0 0.001 units box
fix shiftt3 t3 move linear 0.0 0.0 0.001 units box
fix shiftt4 t4 move linear 0.0 0.0 0.001 units box
fix shiftt5 t5 move linear 0.0 0.0 0.001 units box
fix shiftt6 t6 move linear 0.0 0.0 0.001 units box
fix shiftt7 t7 move linear 0.0 0.0 0.001 units box

# until reaching zt2
run 10000

unfix shiftt2
fix fm2 t2 momentum 1 linear 0 0 1
fix rc2 t2 recenter NULL NULL ${zt2} shift t2

# until reaching zt3
run 10000

unfix shiftt3
fix fm3 t3 momentum 1 linear 0 0 1
fix rc3 t3 recenter NULL NULL ${zt3} shift t3

# until reaching zt4
run 10000

unfix shiftt4
fix fm4 t4 momentum 1 linear 0 0 1
fix rc4 t4 recenter NULL NULL ${zt4} shift t4

# until reaching zt5
run 10000

unfix shiftt5
fix fm5 t5 momentum 1 linear 0 0 1
fix rc5 t5 recenter NULL NULL ${zt5} shift t5

# until reaching zt6
run 10000

unfix shiftt6
fix fm6 t6 momentum 1 linear 0 0 1
fix rc6 t6 recenter NULL NULL ${zt6} shift t6

# until reaching zt7
run 10000

unfix shiftt7
fix fm7 t7 momentum 1 linear 0 0 1
fix rc7 t7 recenter NULL NULL ${zt7} shift t7

# until reaching zt8
run 10000

#write_restart ${restartfile}
write_restart restart_file
write_data data_Stage1.txt pair ii
